import uvicorn
import matplotlib
from fastapi import APIRouter, FastAPI, File, Form, UploadFile, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import Response
from decouple import config, Csv
from pydantic import Json
from pandas import read_csv

from .._models.options import Options
from .._utils.exceptions import InvalidRequestError

from .service import service

# To ensure we can plot in different threads
# https://matplotlib.org/stable/users/faq/howto_faq.html#work-with-threads
# https://matplotlib.org/stable/users/explain/backends.html#selecting-a-backend
matplotlib.use("agg")


app = FastAPI()

origins = [
    "http://localhost:8080",
]

app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

plotter_router = APIRouter(prefix="/plotter")


@plotter_router.post(
    "",
    responses={200: {"content": {"image/png": {}}}},
    # Prevent FastAPI from adding "application/json" as an additional
    # response media type in the autogenerated OpenAPI specification.
    # https://github.com/tiangolo/fastapi/issues/3258
    response_class=Response,
)
def plot_request(
    rawData: UploadFile = File(...),
    rawOptions: Json[Options] = Form(...),
):
    try:
        data = read_csv(rawData.file, sep=",", index_col=0)
        plot_img = service(data, rawOptions)
    except (InvalidRequestError, ValueError) as e:
        raise HTTPException(status_code=400, detail="Bad request: " + str(e))
    except Exception as e:
        raise HTTPException(status_code=500, detail="Oops my bad: " + str(e))
    return Response(plot_img, media_type="image/png")


app.include_router(plotter_router)

if __name__ == "__main__":
    # .env file example:
    # PLOTTER_SERVER=127.0.0.1,8081,debug
    host, port, log_level = config("PLOTTER_SERVER", cast=Csv())
    uvicorn.run(
        "server:app", host=host, port=int(port), log_level=log_level, reload=True
    )
